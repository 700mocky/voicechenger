# Discord ボイスチェンジャー for Mac

BlackHole 仮想オーディオドライバを使って、マイク音声をリアルタイムで変換し Discord に流すツールです。

## 機能

| キー | モード | 変換量 |
|------|--------|--------|
| `1`  | ノーマル | 変換なし |
| `2`  | 高い声   | +6 半音 |
| `3`  | 低い声   | -6 半音 |
| `4`  | 異性の声 | ±10 半音（起動時に性別設定） |
| `q`  | 終了     | — |

---

## セットアップ手順

### 1. BlackHole のインストール

BlackHole は仮想オーディオドライバです。マイク音声を Python スクリプトで処理した後、Discord に渡す「仮想マイク」として機能します。

#### Homebrew でインストール（推奨）

```bash
brew install blackhole-2ch
```

> インストール後に **Mac を再起動** してください。

#### 手動インストール

1. https://github.com/ExistentialAudio/BlackHole へアクセス
2. **Releases** から `BlackHole2ch-X.X.X.pkg` をダウンロード
3. インストーラを実行して再起動

#### インストール確認

「システム設定 → サウンド → 出力」に **BlackHole 2ch** が表示されれば OK です。

---

### 2. Python 環境のセットアップ

#### 必要なライブラリをインストール

```bash
pip install -r requirements.txt
```

> **注意**: Python 3.9 以上を推奨します。

#### （オプション）最高品質ピッチシフトを使う場合

```bash
brew install rubberband
pip install pyrubberband
```

インストールすると、自動的に最高品質エンジンが使われます。

---

### 3. アクセシビリティ権限の付与

`pynput` でキーボード操作を監視するために、**アクセシビリティ権限** が必要です。

1. **システム設定** → **プライバシーとセキュリティ** → **アクセシビリティ** を開く
2. **ターミナル**（または使用している IDE）を追加してチェックを入れる

> 権限がないとキーボード切り替えが動作しませんが、音声変換自体は動作します。

---

## 使い方

### スクリプトを起動

```bash
python main.py
```

起動すると次のように表示されます：

```
==========================================================
  Discord ボイスチェンジャー for Mac  (BlackHole 対応)
==========================================================
ピッチシフトエンジン: librosa（高品質）

=== 利用可能なオーディオデバイス ===
  [ 0] MacBook Pro マイク
  [ 1] MacBook Pro スピーカー
  [ 2] BlackHole 2ch  [★ BlackHole]
  ...

マイクのデバイス番号を入力 (Enter でデフォルト [0]):
BlackHole を自動検出: [2] BlackHole 2ch
このデバイスに出力しますか？ [y/n] (Enter で y):
```

1. **マイクのデバイス番号** を入力（Enter でデフォルトマイクを使用）
2. BlackHole が自動検出されるので `y` で確定
3. 性別設定（`1`: 男→女 / `2`: 女→男）を選択

### Discord の設定

1. Discord を起動
2. **設定（歯車アイコン）** → **音声・ビデオ** を開く
3. **入力デバイス** を `BlackHole 2ch` に変更
4. 出力デバイスは通常のスピーカーのまま

これで Discord が BlackHole（= 変換後の音声）をマイク入力として認識します。

### 自分の声を確認する（モニタリング）

Discord を通じて変換後の声が聞けますが、スクリプト単体で確認したい場合は **Audio MIDI 設定** で「複数出力デバイス」を作成してください。

1. **Finder** → **アプリケーション** → **ユーティリティ** → **Audio MIDI 設定** を起動
2. 左下の `+` → **複数出力デバイスを作成**
3. **BlackHole 2ch** と **内蔵スピーカー** を両方チェック
4. `main.py` の出力先にこの複数出力デバイスを指定

---

## 仕組み

```
マイク → [Python: ピッチシフト処理] → BlackHole 2ch → Discord
```

| コンポーネント | 役割 |
|---|---|
| `sounddevice` | マイク入力・BlackHole 出力のリアルタイム I/O |
| `librosa` | 高品質ピッチシフト（位相ボコーダ方式） |
| `pynput` | キーボードでモード切り替え |
| BlackHole 2ch | 仮想オーディオデバイス（変換音声を Discord に渡す） |

---

## トラブルシューティング

### `BlackHole が見つかりません` と表示される

→ BlackHole をインストールして **再起動** してください。

### `PortAudioError` が出る

→ デバイス番号が正しいか確認してください。`python main.py` 起動時の一覧で番号を確認し、再指定してください。

### キーボード切り替えが効かない

→ **アクセシビリティ権限** を付与してください（セットアップ手順 3 参照）。

### 音が遅延する・途切れる

→ `main.py` の先頭にある `BLOCK_SIZE` を調整してください。

```python
BLOCK_SIZE = 2048   # レイテンシ低減（品質が下がる場合あり）
BLOCK_SIZE = 8192   # 品質向上（遅延が増える）
```

### 音質を上げたい

pyrubberband をインストールすると最高品質エンジンに自動切り替えされます：

```bash
brew install rubberband
pip install pyrubberband
```

---

## ファイル構成

```
voicechenger/
├── README.md         # このファイル
├── requirements.txt  # 依存ライブラリ
└── main.py           # ボイスチェンジャー本体
```

## ライセンス

MIT
